# conftest.py
import os
import subprocess
from datetime import datetime
from pathlib import Path

import pytest
from dotenv import load_dotenv
from jira import JIRA

load_dotenv()

ARTIFACT_DIR = Path("artifacts")

def _jira_client() -> JIRA:
    base_url = os.environ["JIRA_BASE_URL"]
    email = os.environ["JIRA_EMAIL"]
    token = os.environ["JIRA_API_TOKEN"]
    return JIRA(server=base_url, basic_auth=(email, token))

def _safe_filename(name: str) -> str:
    # 윈도우 파일명 안전 처리
    return "".join(c if c.isalnum() or c in "._-[]" else "_" for c in name)[:180]

def _save_logcat(out_path: Path) -> None:
    # 필요하면 -d 대신 특정 시간/필터로 조정 가능
    try:
        result = subprocess.run(
            ["adb", "logcat", "-d"],
            capture_output=True,
            text=True,
            timeout=20,
            check=False,
        )
        out_path.write_text(result.stdout + "\n\n[stderr]\n" + result.stderr, encoding="utf-8", errors="ignore")
    except Exception as e:
        out_path.write_text(f"failed to collect logcat: {e}", encoding="utf-8")

def _create_or_reuse_jira_bug(test_nodeid: str, test_name: str, error_text: str, env_text: str, labels: list[str]):
    jira = _jira_client()
    project_key = os.environ["JIRA_PROJECT_KEY"]
    issue_type = os.environ.get("JIRA_ISSUE_TYPE", "Bug")

    summary = f"[AUTO][Android] {test_name} 실패"
    description = (
        f"*자동화 테스트 실패로 생성됨*\n\n"
        f"*Test:* {test_nodeid}\n"
        f"*Time:* {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
        f"*Environment*\n{env_text}\n\n"
        f"*Error*\n{{code}}\n{error_text[:30000]}\n{{code}}\n"
    )

    # (선택) 중복 방지: 같은 테스트명이면서 해결되지 않은 AUTO 이슈가 있으면 재사용
    # Jira 설정/권한에 따라 JQL이 다를 수 있어요.
    try:
        jql = (
            f'project = {project_key} AND issuetype = "{issue_type}" '
            f'AND statusCategory != Done AND summary ~ "{test_name}" '
            f'AND labels = auto-test'
        )
        existing = jira.search_issues(jql, maxResults=1)
        if existing:
            return existing[0]
    except Exception:
        pass

    issue = jira.create_issue(
        project={"key": project_key},
        summary=summary,
        description=description,
        issuetype={"name": issue_type},
        labels=list(set(labels + ["auto-test", "appium", "pytest", "android"])),
    )
    return issue

def _attach_files(jira: JIRA, issue_key: str, file_paths: list[Path]) -> None:
    for p in file_paths:
        if p and p.exists():
            with p.open("rb") as f:
                jira.add_attachment(issue=issue_key, attachment=f)

@pytest.hookimpl(hookwrapper=True)
def pytest_runtest_makereport(item, call):
    outcome = yield
    rep = outcome.get_result()

    # call 단계(테스트 본문 실행)에서 실패만 처리 (setup 실패도 잡고 싶으면 조건 조정)
    if rep.when != "call" or not rep.failed:
        return

    ARTIFACT_DIR.mkdir(parents=True, exist_ok=True)
    test_name = _safe_filename(item.name)
    stamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    prefix = f"{test_name}__{stamp}"

    # Appium driver fixture 이름이 driver라고 가정
    driver = item.funcargs.get("driver")

    screenshot_path = ARTIFACT_DIR / f"{prefix}.png"
    source_path = ARTIFACT_DIR / f"{prefix}.xml"
    logcat_path = ARTIFACT_DIR / f"{prefix}_logcat.txt"

    # 증거 수집
    if driver:
        try:
            driver.get_screenshot_as_file(str(screenshot_path))
        except Exception:
            screenshot_path = None

        try:
            source_path.write_text(driver.page_source, encoding="utf-8", errors="ignore")
        except Exception:
            source_path = None

    _save_logcat(logcat_path)

    # 환경정보(원하는 만큼 추가)
    env_text = "- Platform: Android\n- Framework: Appium + pytest\n"
    # 여기서 deviceName, appVersion 등을 capabilities에서 뽑아 넣을 수도 있어요.
    try:
        if driver and hasattr(driver, "capabilities"):
            caps = driver.capabilities
            env_text += f"- deviceName: {caps.get('deviceName')}\n"
            env_text += f"- platformVersion: {caps.get('platformVersion')}\n"
            env_text += f"- appPackage: {caps.get('appPackage')}\n"
    except Exception:
        pass

    error_text = rep.longreprtext

    # Jira 이슈 생성
    issue = _create_or_reuse_jira_bug(
        test_nodeid=item.nodeid,
        test_name=item.name,
        error_text=error_text,
        env_text=env_text,
        labels=["ui-test"],
    )

    # 첨부파일 업로드
    jira = _jira_client()
    attach_list = [p for p in [screenshot_path, source_path, logcat_path] if p]
    try:
        _attach_files(jira, issue.key, attach_list)
    except Exception:
        # 첨부 실패해도 테스트 자체 흐름은 유지
        pass

    # 콘솔에 Jira 키 표시(원하면)
    print(f"\n[JIRA] created/linked issue: {issue.key}\n")
