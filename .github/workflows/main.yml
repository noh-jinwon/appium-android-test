name: Android Appium CI (emulator-runner)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  appium-test:
    runs-on: ubuntu-latest
    timeout-minutes: 40  # 여유 있게

    steps:
      # 1) 코드
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3) Node (Appium 2 설치용)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4) Android SDK
      - name: Install Android SDK
        uses: android-actions/setup-android@v3

      # 5) 에뮬레이터 기동 + 같은 스텝의 script에서 Appium/Gradle 테스트 실행
      #    종료(post) 타이밍의 ADB 에러를 전체 실패로 보지 않기 위해 best‑effort 처리
      - name: Start emulator & run tests
        continue-on-error: true
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 30               # 성공했던 API 레벨 유지
          target: google_apis         # PlayStore 미포함
          arch: x86_64
          profile: pixel_4            # 선택 사항
          disable-animations: false   # ← 액션 내부 settings 호출 비활성화(중요)
          emulator-options: >-
            -no-window -gpu swiftshader_indirect
            -no-snapshot -no-audio -no-boot-anim
          script: |
            set -euxo pipefail

            # (A) 부팅 최종 확인: sys.boot_completed = 1 (완전 부팅 판정 표준)
            adb wait-for-device
            until [ "$(adb shell getprop sys.boot_completed | tr -d '\r')" = "1" ]; do
              sleep 2
            done

            # (B) 잠금 해제 (안정화)
            adb shell input keyevent 82 || true

            # (C) 애니메이션 OFF - 서비스 준비 지연을 고려해 재시도 루프 적용
            for k in window_animation_scale transition_animation_scale animator_duration_scale; do
              n=0
              until adb shell settings put global "$k" 0.0 >/dev/null 2>&1 || [ $n -ge 10 ]; do
                n=$((n+1))
                sleep 1
              done
            done
            # 화면 항상 켜짐(전원 연결 시) — 필수 아님, 실패해도 무시
            adb shell settings put global stay_on_while_plugged_in 3 || true

            # (D) Appium 2 + uiautomator2 설치 및 서버 기동
            npm install -g appium@next
            appium driver install uiautomator2
            nohup appium > appium.log 2>&1 &

            # (E) Gradle 실행 권한 및 버전 확인(선택)
            chmod +x ./gradlew
            java -version || true
            adb --version || true
            node -v || true
            npm -v || true

            # (F) 특정 테스트 클래스만 실행
            ./gradlew clean test \
              --tests "com.example.appium.BasicAppiumTest_emul" \
              --stacktrace | tee gradle.log

            # (G) 로그/리포트 수집 (아티팩트로 올릴 파일만 정리)
            mkdir -p ci-logs
            cp -f gradle.log ci-logs/gradle.log || true
            cp -f appium.log ci-logs/appium.log || true
            adb logcat -d > ci-logs/logcat.txt || true
            adb shell getprop > ci-logs/getprop.txt || true
            if [ -d "build/reports/tests/test" ]; then
              tar -czf ci-logs/test-report.tgz build/reports/tests/test
            fi
            if [ -d "build/test-results/test" ]; then
              tar -czf ci-logs/test-results.tgz build/test-results/test
            fi

      # 6) 아티팩트 업로드 (항상)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-reports
          path: ci-logs
          if-no-files-found: warn

      # (1) Xray Cloud 토큰 발급
      - name: Get Xray token
        id: xray-auth
        shell: bash
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
        run: |
          set -euo pipefail
          TOKEN="$(curl -s -X POST "https://xray.cloud.getxray.app/api/v2/authenticate" \
            -H "Content-Type: application/json" \
            -d "{\"client_id\": \"${XRAY_CLIENT_ID}\", \"client_secret\": \"${XRAY_CLIENT_SECRET}\"}")"
          echo "token=${TOKEN}" >> "$GITHUB_OUTPUT"
      
      - name: Upload JUnit to Xray (Cloud v2)
        if: always()
        shell: bash
        env:
          XRAY_TOKEN: ${{ steps.xray-auth.outputs.token }}
        run: |
          set -euo pipefail
      
          # 0) 어디에 리포트가 생겼는지 진단 출력
          echo "== Gradle reports =="
          ls -alh build/test-results/test || true
          ls -alh */build/test-results/test || true
      
          # 1) XML 수집 (루트/하위 모듈 모두 포함)
          mapfile -t FILES < <(find . -type f -path "*/build/test-results/test/*.xml")
      
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "::warning::No JUnit XML found under */build/test-results/test/*.xml . Did tests run?"
            echo "Tip) check your module path or Gradle task. For a multi-module project run : ./gradlew clean test"
            exit 0  # 결과 없으면 업로드 스킵(실패 아님)
          fi
      
          # 2) (옵션) zip으로 묶어 한 번에 업로드하려면 아래 주석 해제
          # zip -q -j xray-junit.zip "${FILES[@]}"
          # curl -s -X POST "https://xray.cloud.getxray.app/api/v2/import/execution/junit/multipart?projectKey=PROJ&testEnvironments=android-emul" \
          #   -H "Authorization: Bearer ${XRAY_TOKEN}" \
          #   -H "Content-Type: multipart/form-data" \
          #   -F "file=@xray-junit.zip"
      
          # 3) 표준 엔드포인트로 개별 업로드
          for f in "${FILES[@]}"; do
            echo "Uploading $f"
            curl -s -f -X POST "https://xray.cloud.getxray.app/api/v2/import/execution/junit?projectKey=PROJ&testEnvironments=android-emul" \
              -H "Authorization: Bearer ${XRAY_TOKEN}" \
              -H "Content-Type: multipart/form-data" \
              -F "file=@${f}"
            echo ""
          done
