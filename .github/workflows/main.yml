name: Android Appium CI (stable)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  appium-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 전체 잡 타임아웃

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android SDK
        uses: android-actions/setup-android@v3

      # 필수 SDK 컴포넌트 & system image (PlayStore 미포함 google_apis, x86_64)
      - name: Install SDK packages
        run: |
          sdkmanager --install "platform-tools" "platforms;android-30" "emulator" \
            "system-images;android-30;google_apis;x86_64"

      - name: Create AVD
        run: echo "no" | avdmanager create avd -n test -k "system-images;android-30;google_apis;x86_64"

      # 헤드리스 + SwiftShader(소프트웨어 렌더러) + no-snapshot + verbose 로그
      - name: Start emulator (headless)
        run: |
          nohup $ANDROID_HOME/emulator/emulator-headless -avd test \
            -no-window -no-audio -no-boot-anim -no-snapshot \
            -gpu swiftshader_indirect -accel off \
            -verbose > emulator.log 2>&1 &

      # 부팅 완료 대기 (정확히 5분 타임아웃). 부팅 신호는 sys.boot_completed=1
      - name: Wait for emulator (max 5 minutes)
        shell: bash
        run: |
          set -e
          adb wait-for-device
          # 최대 300초(5분) 동안 sys.boot_completed == 1 기다리기
          timeout 300 bash -c 'until [[ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d "\r")" == "1" ]]; do sleep 2; done'
          # 잠금 해제 및 애니메이션 끄기(안정성)
          adb shell input keyevent 82 || true
          adb shell settings put global window_animation_scale 0.0 || true
          adb shell settings put global transition_animation_scale 0.0 || true
          adb shell settings put global animator_duration_scale 0.0 || true

      # Node + Appium + uiautomator2
      - name: Install Node & Appium
        run: |
          sudo apt-get update
          sudo apt-get install -y nodejs npm
          npm install -g appium@next
          appium driver install uiautomator2

      - name: Start Appium server
        run: |
          nohup appium > appium.log 2>&1 &

      - name: Gradle permission
        run: chmod +x gradlew

      # 네가 지정한 단일 클래스만 실행
      - name: Run BasicAppiumTest_emul only
        run: |
          ./gradlew clean test --tests "com.example.appium.BasicAppiumTest_emul" --stacktrace | tee gradle.log

      # ---- 디버그 & 로그 수집 (항상) ----
      - name: Snapshot props & devices (debug)
        if: always()
        run: |
          mkdir -p ci-logs
          adb devices -l > ci-logs/adb-devices.txt 2>&1 || true
          adb shell getprop > ci-logs/getprop.txt 2>&1 || true
          # 부팅 진단용 대표 프로퍼티
          adb shell getprop sys.boot_completed > ci-logs/prop-boot-completed.txt 2>&1 || true
          adb shell getprop dev.bootcomplete > ci-logs/prop-dev-bootcomplete.txt 2>&1 || true

      - name: Collect logs (emulator/appium/gradle/test reports)
        if: always()
        run: |
          mkdir -p ci-logs
          cp -f emulator.log ci-logs/emulator.log 2>/dev/null || true
          cp -f appium.log ci-logs/appium.log 2>/dev/null || true
          cp -f gradle.log ci-logs/gradle.log 2>/dev/null || true
          adb logcat -d > ci-logs/logcat.txt 2>&1 || true
          if [ -d "build/reports/tests/test" ]; then
            tar -czf ci-logs/test-report.tgz build/reports/tests/test
          fi
          if [ -d "build/test-results/test" ]; then
            tar -czf ci-logs/test-results.tgz build/test-results/test
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-reports
          path: ci-logs
          if-no-files-found: warn
