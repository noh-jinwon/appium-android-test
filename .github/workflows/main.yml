name: Appium Android CI (manual SDK install, API 33, PATH fixed)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  appium-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk

    steps:
      # 0) Checkout은 가장 먼저! (PATH 건드리기 전)
      - name: Checkout code
        uses: actions/checkout@v4

      # 1) Java 17
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 2) Node.js + Appium + uiautomator2
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Appium & driver
        run: |
          npm install -g appium
          appium -v
          appium driver install uiautomator2
          appium driver list --installed

      # 3) Gradle 캐시(권장)
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4) Android cmdline-tools 수동 설치 + 필수 패키지 설치 (API 33)
      - name: Install Android command line tools (manual)
        run: |
          set -e
          sudo mkdir -p $ANDROID_HOME/cmdline-tools
          sudo chown -R $USER:$USER $ANDROID_HOME
          cd $ANDROID_HOME/cmdline-tools
          curl -sSL -o cmdtools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          mkdir -p latest
          unzip -q cmdtools.zip -d latest
          rm -f cmdtools.zip

          # sdkmanager 버전 확인 (PATH에 아직 안 올렸으므로 직접 경로로 호출)
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --version || true

          # 라이선스 선승인
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

          # 필수 패키지 설치 (API 33)
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "emulator" \
            "system-images;android-33;google_apis;x86_64"

      # 5) 이제 PATH에 Android 도구 경로를 '추가' (덮어쓰기 금지)
      - name: Add Android tools to PATH
        run: |
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH

      # 6) 에뮬레이터 생성 & 부팅 (API 33와 일치)
      - name: Create & boot emulator (API 33)
        shell: bash
        run: |
          set -e
          echo "no" | avdmanager create avd -n test -k "system-images;android-33;google_apis;x86_64" --device "pixel"
          $ANDROID_HOME/emulator/emulator -list-avds
          nohup $ANDROID_HOME/emulator/emulator -avd test -no-snapshot -noaudio -no-boot-anim -gpu swiftshader_indirect -no-window > emulator.log 2>&1 &
          adb wait-for-device
          # 부팅 완료 대기 (최대 5분)
          bootcomplete=""
          timeout=0
          while [ -z "$bootcomplete" ] && [ $timeout -lt 300 ]; do
            sleep 5
            bootcomplete=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            echo "boot_completed=$bootcomplete (t=$timeout)"
            timeout=$((timeout+5))
          done
          adb devices -l
          adb shell input keyevent 82 || true

      # 7) Appium 서버 기동 + 포트 준비 대기
      - name: Start Appium server
        run: |
          nohup appium --base-path /wd/hub > appium.log 2>&1 &
          for i in {1..30}; do
            nc -z 127.0.0.1 4723 && echo "Appium is up" && break
            sleep 2
          done
          curl -s http://127.0.0.1:4723/wd/hub/status || true

      # 8) Gradle 실행 권한
      - name: Grant Gradle permission
        run: chmod +x ./gradlew

      # 9) (선택) APK 빌드
      # - name: Build APK (optional)
      #   run: ./gradlew assembleDebug --stacktrace

      # 10) 테스트 실행
      - name: Run Tests
        run: ./gradlew test --stacktrace --info

      # 11) 아티팩트 업로드 (항상)
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts
          path: |
            **/build/test-results/test/*.xml
            **/build/reports/tests/test/**
            appium.log
            emulator.log
