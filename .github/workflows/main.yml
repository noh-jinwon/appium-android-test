name: Android Appium CI (emulator-runner)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  appium-test:
    runs-on: ubuntu-latest
    timeout-minutes: 40  # 여유 있게

    steps:
      # 1) 코드
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3) Node (최근 버전) - Appium 2 설치를 위해
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4) Android SDK
      - name: Install Android SDK
        uses: android-actions/setup-android@v3

      # 5) 에뮬레이터 기동 + 스크립트 내에서 Appium/Gradle 테스트 실행
      - name: Start emulator & run tests
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 30               # 네가 성공했던 API 레벨 그대로 사용
          target: google_apis         # PlayStore 미포함
          arch: x86_64
          profile: pixel_4            # 원하면 변경 가능(선택)
          disable-animations: true
          emulator-options: >-
            -no-window -gpu swiftshader_indirect
            -no-snapshot -no-audio -no-boot-anim
          script: |
            set -euxo pipefail

            # (선택) adb 상태 확인
            adb devices

            # Appium 2 설치 + 드라이버
            npm install -g appium@next
            appium driver install uiautomator2

            # Appium 서버 백그라운드 기동 (기본 포트 4723)
            nohup appium > appium.log 2>&1 &

            # Gradle 실행 권한
            chmod +x ./gradlew

            # (선택) JDK/ADB/Node 확인
            java -version || true
            adb --version || true
            node -v || true
            npm -v || true

            # 특정 테스트만 실행 (로그 파일 저장)
            ./gradlew clean test --tests "com.example.appium.BasicAppiumTest_emul" --stacktrace | tee gradle.log

            # 로그/리포트 수집 (작업공간에 남겨둠 → 다음 스텝에서 업로드)
            mkdir -p ci-logs
            cp -f gradle.log ci-logs/gradle.log || true
            cp -f appium.log ci-logs/appium.log || true
            adb logcat -d > ci-logs/logcat.txt || true
            adb shell getprop > ci-logs/getprop.txt || true

            if [ -d "build/reports/tests/test" ]; then
              tar -czf ci-logs/test-report.tgz build/reports/tests/test
            fi
            if [ -d "build/test-results/test" ]; then
              tar -czf ci-logs/test-results.tgz build/test-results/test
            fi

      # 6) 아티팩트 업로드 (항상)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-reports
          path: ci-logs
          if-no-files-found: warn
