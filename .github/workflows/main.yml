name: Android Appium CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  appium-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30   # 전체 잡 타임아웃 (무한 대기 방지)

    steps:
      # 1) 소스 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) JDK 17
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3) Android SDK 설치
      - name: Install Android SDK
        uses: android-actions/setup-android@v3

      # 4) 에뮬레이터 시스템 이미지 설치 (Play Store 미포함 이미지 권장)
      - name: Install emulator image
        run: |
          sdkmanager --install "system-images;android-30;google_apis;x86_64"

      # 5) AVD 생성
      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd -n test -k "system-images;android-30;google_apis;x86_64"

      # 6) 에뮬레이터 실행 (헤드리스 + 소프트웨어 렌더링)
      - name: Start emulator
        run: |
          nohup emulator -avd test \
            -no-window \
            -no-audio \
            -gpu swiftshader_indirect \
            -no-snapshot \
            -verbose > emulator.log 2>&1 &

      # 7) 부팅 완료 대기 (최대 5분 타임아웃)
      - name: Wait for emulator (max 5 min)
        shell: bash
        run: |
          set -e
          adb wait-for-device
          # 300초(5분) 타임아웃: sys.boot_completed == 1 기다림
          timeout 300 bash -c 'until [[ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d "\r")" == "1" ]]; do sleep 2; done'
          # 잠금 해제
          adb shell input keyevent 82

      # 8) Node + Appium + uiautomator2 설치
      - name: Install Node & Appium
        run: |
          sudo apt-get update
          sudo apt-get install -y nodejs npm
          npm install -g appium@next
          appium driver install uiautomator2

      # 9) Appium 서버 백그라운드 실행
      - name: Start Appium server
        run: |
          nohup appium > appium.log 2>&1 &

      # 10) Gradle 권한
      - name: Gradle permission
        run: chmod +x gradlew

      # 11) 테스트 실행 (해당 클래스만)
      #     실행 로그를 파일로도 저장 (tee)
      - name: Run only BasicAppiumTest_emul
        run: |
          ./gradlew clean test --tests "com.example.appium.BasicAppiumTest_emul" --stacktrace | tee gradle.log

      # 12) 테스트 후 로그 수집 (항상 실행)
      - name: Collect logs (emulator/app/gradle)
        if: always()
        run: |
          mkdir -p ci-logs
          # Gradle 실행 로그
          cp -f gradle.log ci-logs/gradle.log 2>/dev/null || true
          # 에뮬레이터 실행 로그
          cp -f emulator.log ci-logs/emulator.log 2>/dev/null || true
          # Appium 서버 로그
          cp -f appium.log ci-logs/appium.log 2>/dev/null || true
          # 장치 로그캣 (최신 스냅샷)
          adb logcat -d > ci-logs/logcat.txt || true
          # (선택) 테스트 리포트/결과물
          if [ -d "build/reports/tests/test" ]; then
            tar -czf ci-logs/test-report.tgz build/reports/tests/test
          fi
          if [ -d "build/test-results/test" ]; then
            tar -czf ci-logs/test-results.tgz build/test-results/test
          fi

      # 13) 아티팩트 업로드 (항상)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: appium-emulator-gradle-logs
          path: ci-logs
          if-no-files-found: warn
