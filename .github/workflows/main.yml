name: Android Appium CI (hard-timeout-5m)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  appium-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android SDK
        uses: android-actions/setup-android@v3

      - name: Install SDK packages
        run: |
          sdkmanager --install "platform-tools" "platforms;android-30" "emulator" \
            "system-images;android-30;google_apis;x86_64"

      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd -n test -k "system-images;android-30;google_apis;x86_64"

      # 에뮬레이터 실행 (헤드리스+SwiftShader). PID 저장해두고, 실패 시 강제 kill
      - name: Start emulator (headless)
        run: |
          set -e
          nohup $ANDROID_HOME/emulator/emulator-headless -avd test \
            -no-window -no-audio -no-boot-anim -no-snapshot \
            -gpu swiftshader_indirect -accel off \
            -verbose > emulator.log 2>&1 &
          echo $! > emulator.pid

      # ★ 5분 하드 타임아웃: adb 대기 + sys.boot_completed 확인을 하나의 timeout 블록으로 감싼다
      - name: Wait for emulator (≤5m hard timeout)
        shell: bash
        run: |
          set -euo pipefail
          # 전체 대기를 하나의 timeout 블록으로 감싸서 반드시 300초에 종료되게 한다
          if ! timeout --foreground -k 10s 300 bash -c '
            adb kill-server || true
            adb start-server
            adb wait-for-device
            # 완전 부팅 대기
            until [ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d "\r")" = "1" ]; do
              sleep 2
            done
            # 화면 잠금 해제 + 애니메이션 off
            adb shell input keyevent 82 || true
            adb shell settings put global window_animation_scale 0.0 || true
            adb shell settings put global transition_animation_scale 0.0 || true
            adb shell settings put global animator_duration_scale 0.0 || true
          '; then
            echo "::error::Emulator failed to boot within 300s. Killing emulator..."
            # 에뮬레이터 강제 종료
            if [ -f emulator.pid ]; then
              kill -9 "$(cat emulator.pid)" 2>/dev/null || true
            fi
            pkill -9 -f "emulator.*-avd test" 2>/dev/null || true
            exit 124
          fi

      - name: Install Node & Appium
        run: |
          sudo apt-get update
          sudo apt-get install -y nodejs npm
          npm install -g appium@next
          appium driver install uiautomator2

      - name: Start Appium server
        run: |
          nohup appium > appium.log 2>&1 &

      - name: Gradle permission
        run: chmod +x gradlew

      # 네가 지정한 단일 클래스만 실행
      - name: Run only BasicAppiumTest_emul
        run: |
          ./gradlew clean test --tests "com.example.appium.BasicAppiumTest_emul" --stacktrace | tee gradle.log

      # 디버그/로그 수집 (항상 실행)
      - name: Collect debug snapshots
        if: always()
        run: |
          mkdir -p ci-logs
          adb devices -l > ci-logs/adb-devices.txt 2>&1 || true
          adb shell getprop > ci-logs/getprop.txt 2>&1 || true
          adb shell getprop sys.boot_completed > ci-logs/prop-boot-completed.txt 2>&1 || true
          adb shell getprop dev.bootcomplete > ci-logs/prop-dev-bootcomplete.txt 2>&1 || true
          cp -f emulator.log ci-logs/emulator.log 2>/dev/null || true
          cp -f appium.log ci-logs/appium.log 2>/dev/null || true
          cp -f gradle.log ci-logs/gradle.log 2>/dev/null || true
          adb logcat -d > ci-logs/logcat.txt 2>&1 || true
          if [ -d "build/reports/tests/test" ]; then tar -czf ci-logs/test-report.tgz build/reports/tests/test; fi
          if [ -d "build/test-results/test" ]; then tar -czf ci-logs/test-results.tgz build/test-results/test; fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-reports
          path: ci-logs
          if-no-files-found: warn
